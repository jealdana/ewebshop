<div class="container-fluid">
    <div class="row">
    {% if admin %}
      {% include 'frontend/productComponents/sideNavBarProducts.html' %}
    {% endif %}    
      <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4"><div class="chartjs-size-monitor" style="position: absolute; inset: 0px; overflow: hidden; pointer-events: none; visibility: hidden; z-index: -1;"><div class="chartjs-size-monitor-expand" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;"><div style="position:absolute;width:1000000px;height:1000000px;left:0;top:0"></div></div><div class="chartjs-size-monitor-shrink" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;"><div style="position:absolute;width:200%;height:200%;left:0; top:0"></div></div></div>
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">

            <div class="col-4">
                <h1 class="h2">Products</h1>
            </div>
            <div class="col">
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="input-group w-100">
                        <select id="productSearchFilter" value='name' class="custom-select">
                            <option selected value="name" >Name</option>
                            <option value="code" >Code</option>
                          </select>
                        <input id="productSearchInput" type="text" class="form-control" aria-label="Text input with dropdown button">
                        <div class="input-group-append">
                            <button onclick="filterProd()" class="btn btn-outline-secondary" type="button">Search</button>
                            <button onclick="allProd()" class="btn btn-outline-secondary" type="button">All</button>
                            <form class="float-end" action="/" id="sortForm">
                                <label for="sortItems">Sort by: </label>
                                <select id="sortItems" class="custom-select btn " value='name' name="sortlist" form="sortForm">
                                  <option class="text-secondary" value="name">Name</option>
                                  <option class="text-secondary" value="price">Price</option>
                                </select>
                              </form>
                        </div>
                    </div>
                </div>          
            </div>
            
        </div>
        {% if user.is_authenticated %}
        <div class="row g-4 mb-3">
          <div class="accordion" id="accordionExample">
            <div class="card">
              <div class="card-header" id="heading-{{ product.id }}">
                <h2 class="mb-0 text-center">
                  <button class="btn btn-link btn-block" type="button" data-toggle="collapse" data-target="#collapse-{{ product.id }}" aria-expanded="true" aria-controls="collapse-{{ product.id }}">
                    Add product
                  </button>
                </h2>
              </div>
          
              <div id="collapse-{{ product.id }}" class="collapse" aria-labelledby="heading-{{ product.id }}" data-parent="#accordionExample">
                <div class="card-body p-3">                                    
                  <form id="prodCreate">{% csrf_token %}
                    <label for="photo_url">photo_url</label>
                    <input type="url" name="photo_url" id="photo_url"><br>

                    <label for="name">name</label>
                    <input type="text" name="name" id="name"><br>

                    <label for="code">code</label>
                    <input type="text" name="code" id="code"><br>

                    <label for="price">price</label>
                    <input type="number" name="price" id="price"><br>

                    <label for="description">description</label> <br>                                        
                    <textarea id="description" name="description" rows="3" cols="20"></textarea><br>
                    <input type="submit" value="Submit">
                  </form>
                  <br></br>
                    
                      
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        <div id='productsList' class="row row-cols-1 row-cols-md-3 g-4">
            
          </div>
        <div class="table-responsive">
        </div>
      </main>
    </div>
  </div>


  <script>
    function createDiv(type,kwargs = {className:'',innerText:'',innerHTML:''}){
        let divCustom = document.createElement(type);
        divCustom.innerText = (kwargs.innerText === '') ? "" : kwargs.innerText;        
        divCustom.className = (kwargs.className === '') ? "" : kwargs.className;
        return divCustom;
      
    }


    let descriptionCart = (product) => {
      let accordion = createDiv('div',{className:'accordion',innerText:'',innerHTML:''});
      accordion.innerHTML = `
      <div class="accordion" id="accordionExample">
                            <div class="card">
                              <div class="card-header" id="heading-${product.id}">
                                <h2 class="mb-0 text-center">
                                  <button class="btn btn-link btn-block" type="button" data-toggle="collapse" data-target="#collapse-${product.id}" aria-expanded="true" aria-controls="collapse-${product.id}">
                                    see more
                                  </button>
                                </h2>
                              </div>
                          
                              <div id="collapse-${product.id}" class="collapse" aria-labelledby="heading-${product.id}" data-parent="#accordionExample">
                                <div class="card-body p-3">                                    
                                    ${product.description}
                                    <br></br>
                                    <form id="addCart" value="${product.id}" >
                                        <label for="quantity">Quantity:</label>
                                        <div class="input-group mb-3">
                                            <input type="number" id="quantity" name="quantity" min="1" class="form-control" placeholder="1" value='1' aria-label="Recipient's username" aria-describedby="basic-addon2">
                                            <div class="input-group-append">
                                              <button class="btn btn-primary" type="submit">Add to cart</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                              </div>
                            </div>
                          </div>  
      `;
      accordion.setAttribute('id',"accordionExample");
      let card = createDiv('div',{className:'card',innerText:'',innerHTML:''});
      let cardHeader = createDiv('div',{className:'card-header',innerText:'',innerHTML:''});
      let h2 = createDiv('div',{className:'mb-0 text-center',innerText:'',innerHTML:''});
      let buttonCustom = createDiv('div',{className:'btn btn-link btn-block',innerText:'see more',innerHTML:''});
      let collapseDiv = createDiv('div',{className:'collapse',innerText:'',innerHTML:''});
      let cardBody = createDiv('div',{className:'card-body p-3',innerText:'',innerHTML:''});
      let form = createDiv('div',{className:'card',innerText:'',innerHTML:''});
      let label = createDiv('div',{className:'card',innerText:'Quantity:',innerHTML:''});
      let inputGroup= createDiv('div',{className:'input-group mb-3',innerText:'',innerHTML:''});
      let inputQty = createDiv('div',{className:'form-control',innerText:'',innerHTML:''});
      let inputButtonGroup = createDiv('div',{className:'input-group-append',innerText:'',innerHTML:''});
      let inputButton = createDiv('div',{className:'btn btn-primary',innerText:'',innerHTML:''});
      return accordion;
    }

    let createTaskCard = (product) => {

      let card = createDiv('div',{className:'card',innerText:'',innerHTML:''});

      let cardImg = createDiv('img',{className:'card-img-top',innerText:'',innerHTML:''});
        cardImg.setAttribute("src", product.photo_url);
        cardImg.setAttribute("style", "height: 20em;");

      let cardBody = createDiv('div',{className:'card-body',innerText:'',innerHTML:''});
      
      let title = createDiv('h5',{innerText:product.name,className:'card-title'});
      let code = createDiv('p',{innerText:`Code ${product.code}`,className:'card-text'});
      let price = createDiv('p',{innerText:`USD $ ${product.price}`,className:'card-text'});

      let footer = createDiv('div',{className:'card-footer',innerText:'',innerHTML:''});
      let lastPurchase = createDiv('small',{innerText:`Last purchase made ${Math.floor(Math.random() * 100)} mins ago`,className:'text-muted'});

      
      
      footer.appendChild(lastPurchase);
      cardBody.appendChild(title);
      cardBody.appendChild(code);
      cardBody.appendChild(price);
      cardBody.appendChild(descriptionCart(product));      

      card.appendChild(cardImg);
      card.appendChild(cardBody);
      card.appendChild(footer);
      return card;

    }
  

    $(document).ready(function(){
          $('#productSearchFilter').on('change', function() {
            let productsList = document.getElementById('productSearchFilter')
            if ( this.value == 'name')
            {
              productsList.setAttribute('value','name');
            }
            else
            {
              productsList.setAttribute('value','code');
            }
          });

          $('#sortItems').on('change', function() {
            let productsList = document.getElementById('productSearchFilter');
            if ( this.value == 'name')
            {
              filterProd({value:'name'});
              document.getElementById('sortItems').setAttribute('value','name');
              
            }
            else
            {
              filterProd({value:'price'});
              document.getElementById('sortItems').setAttribute('value','price');
            }
            
          });
    });
    
    function filterProd(order_by={value:'name'}){
      
      let productSearchFilter = document.getElementById('productSearchFilter');
      let productSearchInput = document.getElementById('productSearchInput');
      

      let productsList = document.getElementById('productsList');
      
      fetch(`/product/?${productSearchFilter.getAttribute('value')}=${productSearchInput.value}&order_by=${order_by.value}`)
        .then(response => response.json())
        .then(data => {
          let allProductsMockupList = data.results;
      
          let productsList = document.getElementById('productsList');
          productsList.innerHTML = '';
          
          allProductsMockupList.forEach( product => 
              { 
                let colDiv = createDiv('div',{className:'col',innerText:'',innerHTML:''});
                colDiv.appendChild( createTaskCard(product) );
                productsList.appendChild(colDiv);
              }
            );
        });

      
    }

    
    function allProd(){

      let productSearchFilter = document.getElementById('productSearchFilter');
      let productSearchInput = document.getElementById('productSearchInput');
      productSearchFilter.setAttribute('value','name');
      productSearchInput.value = '';
      
      filterProd({value:document.getElementById('sortItems').getAttribute('value')});

    }

    $(document).on('submit','#prodCreate', function(e){
      e.preventDefault();
      $.ajax({
        type:'POST',
        url:'/product/create/',
        data: {
          photo_url:$('#photo_url').val(),
          name:$('#name').val(),
          code:$('#code').val(),
          price:$('#price').val(),
          description:$('#description').val(),
          csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
        },
        success:function(){
            alert('New product created');
        }
      });
    });

    $(document).on('submit','#addCart', function(e){
      e.preventDefault();

      let qty = $(this).find('input[type=number]').val();
      let prodID = $(this).attr("value");

      fetch(`/product/${prodID}/`).then(response => response.json())
        .then(data => {
          // data is the product json
          let li = createDiv('li', {innerText:``, className:'list-group-item d-flex justify-content-between lh-condensed'});
          let div = createDiv('div', {innerText:``, className:'my-0'});
          let h6 = createDiv('h6', {innerText:`${data.name} - $ ${data.price} X ${qty}`, className:'my-0'});
          //let small = createDiv('small', {innerText:`$ ${data.price} X ${qty}`, className:'text-muted'});
          let span = createDiv('span', {innerText:`$ ${data.price * parseInt(qty) }`, className:'text-muted'});

          div.appendChild(h6);
          //div.appendChild(small);
          li.appendChild(div);
          li.appendChild(span);
          document.getElementById('cartList').appendChild(li);
          let total = document.getElementById('total');
          let new_cost = data.price * parseInt(qty);
          let newTotal = parseFloat(total.getAttribute('value')) + new_cost;
          total.setAttribute('value',newTotal) ;
          total.innerText = newTotal;

          let cartBadge = document.getElementById('cartBadge');
          let newcartBadge = parseFloat(cartBadge.getAttribute('value')) + parseInt(qty);
          cartBadge.setAttribute('value',newcartBadge) ;
          cartBadge.innerText = newcartBadge;

        });
      
    });
    
    $( document ).ready(function() {
      allProd();
    });
  </script>